{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% trans "–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω" %}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 py-8">

  <div class="rounded-3xl bg-white ring-1 ring-black/10 shadow-xl p-6 md:p-8">
    <div class="flex items-start gap-4">
      <div class="w-12 h-12 rounded-2xl bg-green-100 flex items-center justify-center text-2xl">
        ‚úÖ
      </div>
      <div class="flex-1">
        <h1 class="text-2xl md:text-3xl font-extrabold">{% trans "–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω!" %}</h1>
        <div class="mt-1 text-stone-600">
          {% trans "–°–µ–π—á–∞—Å –æ—Ç–∫—Ä–æ–µ–º WhatsApp —Ñ–∏–ª–∏–∞–ª–∞ —Å –≥–æ—Ç–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º." %}
        </div>
        <div class="mt-3 text-sm text-stone-500">
          {% trans "–ó–∞–∫–∞–∑" %} #{{ order.id }} ¬∑ {{ branch.name }}
          {% if is_delivery %} ¬∑ {% trans "–î–æ—Å—Ç–∞–≤–∫–∞" %}{% else %} ¬∑ {% trans "–°–∞–º–æ–≤—ã–≤–æ–∑" %}{% endif %}
        </div>

        {% if items_count %}
          <div class="mt-3 text-sm">
            <div class="font-extrabold text-stone-900">{% trans "–°–æ—Å—Ç–∞–≤" %}:</div>
            <div class="text-stone-700">
              {% for x in items_preview %}
                <div>‚Ä¢ {{ x }}</div>
              {% endfor %}
              {% if items_count > 2 %}
                <div class="text-stone-500 mt-1">
                  {% trans "–∏ –µ—â—ë" %} {{ items_count|add:"-2" }}‚Ä¶
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="mt-6 grid gap-3 sm:grid-cols-2">
      <a href="{{ whatsapp_url }}"
         target="_blank" rel="noopener"
         class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl text-white font-semibold shadow hover:opacity-95"
         style="background:#25D366;">
        üí¨ {% trans "–û—Ç–∫—Ä—ã—Ç—å WhatsApp" %}
      </a>

      {% if call_url %}
      <a href="{{ call_url }}"
         class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl bg-stone-900 text-white font-semibold shadow hover:bg-stone-800">
        üìû {% trans "–ü–æ–∑–≤–æ–Ω–∏—Ç—å" %}
      </a>
      {% else %}
      <a href="{% url 'public_site:branch_menu' branch.id %}"
         class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl bg-stone-900 text-white font-semibold shadow hover:bg-stone-800">
        ‚Üê {% trans "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é" %}
      </a>
      {% endif %}
    </div>

    <!-- Copy -->
    <div class="mt-3">
      <button type="button"
              id="copyBtn"
              class="w-full inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl ring-1 ring-stone-300 hover:bg-stone-50 font-extrabold">
        üìã {% trans "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞" %}
      </button>

      <textarea id="msgText" class="sr-only" aria-hidden="true">{% autoescape off %}{{ msg_text }}{% endautoescape %}</textarea>

      <div id="copyOk" class="hidden mt-2 text-sm rounded-xl bg-green-50 ring-1 ring-green-200 p-3 text-green-900">
        ‚úÖ {% trans "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! –í—Å—Ç–∞–≤—å—Ç–µ –≤ WhatsApp, –µ—Å–ª–∏ –æ–Ω –Ω–µ –æ—Ç–∫—Ä—ã–ª—Å—è." %}
      </div>
      <div id="copyErr" class="hidden mt-2 text-sm rounded-xl bg-amber-50 ring-1 ring-amber-200 p-3 text-amber-900">
        ‚ö†Ô∏è {% trans "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é." %}
      </div>
    </div>

    <div id="waFallback" class="hidden mt-5 rounded-2xl bg-amber-50 ring-1 ring-amber-200 p-4 text-amber-900">
      <div class="font-extrabold">{% trans "WhatsApp –Ω–µ –æ—Ç–∫—Ä—ã–ª—Å—è?" %}</div>
      <div class="text-sm mt-1">
        {% trans "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ‚Äú–û—Ç–∫—Ä—ã—Ç—å WhatsApp‚Äù. –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ—Ç ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è WhatsApp Web. –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ‚Äú–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞‚Äù." %}
      </div>
    </div>

    <div class="mt-6 rounded-2xl bg-stone-50 ring-1 ring-stone-200 p-4">
      <div class="flex justify-between text-sm text-stone-600">
        <span>{% trans "–ü–æ–¥—ã—Ç–æ–≥" %}</span><span>{{ subtotal }} {% trans "—Å–æ–º" %}</span>
      </div>
      {% if is_delivery %}
      <div class="flex justify-between text-sm text-stone-600 mt-2">
        <span>{% trans "–î–æ—Å—Ç–∞–≤–∫–∞" %}</span><span>{{ delivery_fee }} {% trans "—Å–æ–º" %}</span>
      </div>
      {% endif %}
      <div class="flex justify-between text-lg font-extrabold mt-3">
        <span>{% trans "–ò—Ç–æ–≥–æ" %}</span><span>{{ total }} {% trans "—Å–æ–º" %}</span>
      </div>
    </div>

    <div class="mt-6 flex flex-wrap gap-2">
      <a href="{% url 'public_site:branch_menu' branch.id %}"
         class="px-4 py-3 rounded-2xl ring-1 ring-stone-300 hover:bg-stone-50 font-semibold">
        üçΩÔ∏è {% trans "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é" %}
      </a>
    </div>
  </div>
</div>

<script>
  // –∞–≤—Ç–æ-–æ—Ç–∫—Ä—ã—Ç–∏–µ WhatsApp
  (function(){
    const deeplink = "{{ whatsapp_deeplink|escapejs }}";
    if (!deeplink) return;

    window.location.href = deeplink;

    setTimeout(() => {
      const fb = document.getElementById('waFallback');
      if (fb) fb.classList.remove('hidden');
    }, 1200);
  })();

  // copy button
  (function(){
    const btn = document.getElementById('copyBtn');
    const ta = document.getElementById('msgText');
    const ok = document.getElementById('copyOk');
    const err = document.getElementById('copyErr');
    if (!btn || !ta) return;

    function show(el){
      if (!el) return;
      el.classList.remove('hidden');
      setTimeout(()=>el.classList.add('hidden'), 1800);
    }

    btn.addEventListener('click', async () => {
      try{
        const text = ta.value || ta.textContent || '';
        if (navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text);
        } else {
          ta.classList.remove('sr-only');
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          ta.select();
          document.execCommand('copy');
          ta.classList.add('sr-only');
        }
        show(ok);
      } catch(e){
        console.error(e);
        show(err);
      }
    });
  })();
</script>
{% endblock %}
