{% extends "base.html" %}
{% block content %}
<div class="max-w-3xl mx-auto px-4 py-6">
  <div class="rounded-3xl bg-white ring-1 ring-stone-200 p-5 shadow">
    <div class="text-sm text-stone-500">–ö–æ—Ä–∑–∏–Ω–∞ ¬∑ {{ branch.name_ru }} ¬∑ {{ place.title }}</div>
    <h1 class="text-2xl font-extrabold mt-1">–í–∞—à –∑–∞–∫–∞–∑</h1>
  </div>

  {% if rows %}
    <div class="mt-5 space-y-3">
     {% for r in rows %}
  <div class="rounded-3xl bg-white ring-1 ring-stone-200 p-4 flex items-center justify-between gap-4"
       data-row="{{ r.branch_item.id }}">
    <div class="min-w-0">
      <div class="font-semibold">{{ r.branch_item.item.name_ru }}</div>
      <div class="text-sm text-stone-500">
        {{ r.branch_item.price }} —Å–æ–º ¬∑ <span data-line="{{ r.branch_item.id }}">{{ r.line_total }}</span> —Å–æ–º
      </div>
    </div>

    <div class="flex items-center gap-2">
      <button type="button" class="w-10 h-10 rounded-2xl bg-stone-100 font-extrabold"
              data-act="dec" data-id="{{ r.branch_item.id }}">‚àí</button>

      <div class="w-10 text-center font-extrabold" data-qty="{{ r.branch_item.id }}">{{ r.qty }}</div>

      <button type="button" class="w-10 h-10 rounded-2xl bg-stone-900 text-white font-extrabold"
              data-act="inc" data-id="{{ r.branch_item.id }}">+</button>

      <button type="button" class="w-10 h-10 rounded-2xl bg-rose-100 font-extrabold"
              data-act="remove" data-id="{{ r.branch_item.id }}">üóë</button>
    </div>
  </div>
{% endfor %}

<div class="mt-4 rounded-3xl bg-white ring-1 ring-stone-200 p-4 flex items-center justify-between">
  <div class="text-stone-500">–ò—Ç–æ–≥–æ</div>
  <div class="text-xl font-extrabold" id="cart-total">{{ cart_total }} —Å–æ–º</div>
</div>

    </div>


<form action="{% url 'table_create_order' token %}" method="post" class="mt-4 space-y-3">
  {% csrf_token %}
  <input name="customer_name" placeholder="–ò–º—è (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
         class="w-full rounded-2xl ring-1 ring-stone-200 px-4 py-3">
  <textarea name="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
            class="w-full rounded-2xl ring-1 ring-stone-200 px-4 py-3"></textarea>

  <button class="w-full rounded-2xl bg-stone-900 text-white font-extrabold py-4">
    ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
  </button>
</form>

  

    <a href="{% url 'table_menu' token %}"
       class="mt-3 block text-center px-5 py-3 rounded-3xl bg-stone-100 text-stone-900 font-semibold">
      ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–µ–Ω—é
    </a>
  {% else %}
    <div class="mt-6 rounded-3xl bg-white ring-1 ring-stone-200 p-8 text-center">
      <div class="text-xl font-extrabold">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è</div>
      <a href="{% url 'table_menu' token %}" class="mt-4 inline-block px-5 py-3 rounded-2xl bg-stone-900 text-white font-semibold">
        –ü–µ—Ä–µ–π—Ç–∏ –≤ –º–µ–Ω—é
      </a>
    </div>
  {% endif %}
  <form action="{% url 'table_call_waiter' token %}" method="post" data-call-waiter class="mt-3">
  {% csrf_token %}
  <button type="submit" class="w-full rounded-2xl bg-amber-400 font-extrabold py-4">
    üîî –ü–æ–∑–≤–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞
  </button>
</form>

</div>
<script>
  function getCookie(name) {
    const v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return v ? decodeURIComponent(v.split('=')[1]) : '';
  }

  async function cartUpdate(biId, action){
    const fd = new FormData();
    fd.append('branch_item_id', biId);
    fd.append('action', action);

    const resp = await fetch("{% url 'table_cart_update' token %}", {
      method: "POST",
      body: fd,
      headers: {'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With':'XMLHttpRequest'}
    });
    return await resp.json();
  }

  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;

    const action = btn.dataset.act;
    const biId = btn.dataset.id;
    btn.disabled = true;

    try{
      const data = await cartUpdate(biId, action);
      if(!data.ok) return;

      const totalEl = document.getElementById('cart-total');
      if(totalEl) totalEl.textContent = data.total + " —Å–æ–º";

      const row = document.querySelector(`[data-row="${biId}"]`);
      if(!row) return;

      if(data.item_qty <= 0){
        row.remove();
      }else{
        const qtyEl = row.querySelector(`[data-qty="${biId}"]`);
        const lineEl = row.querySelector(`[data-line="${biId}"]`);
        if(qtyEl) qtyEl.textContent = data.item_qty;
        if(lineEl) lineEl.textContent = data.line_total;
      }
    } finally {
      btn.disabled = false;
    }
  });

  // call waiter ajax
  document.addEventListener('submit', async (e)=>{
    const f = e.target.closest('form[data-call-waiter]');
    if(!f) return;
    e.preventDefault();

    const resp = await fetch(f.action, {
      method: 'POST',
      body: new FormData(f),
      headers: {'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With':'XMLHttpRequest'}
    });
    const data = await resp.json();
    if(data.ok) alert("‚úÖ –û—Ñ–∏—Ü–∏–∞–Ω—Ç –≤—ã–∑–≤–∞–Ω!");
  }, true);
</script>

{% endblock %}
