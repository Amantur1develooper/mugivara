{% extends "base.html" %}
{% load i18n %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-6">
  <div class="flex items-start justify-between gap-4">
    <div>
      <h1 class="text-2xl font-extrabold">{% trans "План зала" %}</h1>
      <div class="text-stone-600 text-sm mt-1">{{ branch.name_ru }} · {{ branch.address }}</div>
    </div>
    <a href="{% url 'public_site:branch_menu' branch.id %}"
       class="px-4 py-2 rounded-xl ring-1 ring-stone-200 hover:bg-stone-50">
      ← {% trans "Меню" %}
    </a>
  </div>

  {% if messages %}
    <div class="mt-4 space-y-2">
      {% for m in messages %}
        <div class="rounded-2xl p-3 ring-1 ring-stone-200 bg-white">{{ m }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="mt-6 space-y-8">
    {% for f in floors_data %}
      <section class="rounded-3xl bg-white ring-1 ring-stone-200 p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-extrabold">{{ f.floor.name_ru }}</h2>
          <div class="text-sm text-stone-500">{% trans "Этаж" %}</div>
        </div>

        <!-- План этажа -->
        <div class="mt-4 relative rounded-2xl bg-stone-50 ring-1 ring-stone-200 overflow-hidden"
             style="height: 520px;">
          {% for row in f.places %}
            {% with p=row.obj b=row.booking %}
              <div
                class="place absolute rounded-2xl ring-1 shadow-sm cursor-move select-none
                       {% if b %}bg-rose-50 ring-rose-200{% else %}bg-emerald-50 ring-emerald-200{% endif %}"
                style="left: {{ p.x }}px; top: {{ p.y }}px; width: 160px; padding: 10px;"
                data-place-id="{{ p.id }}"
                data-move-url="{% url 'public_site:place_move' p.id %}"
                data-create-url="{% url 'public_site:reserve_create' branch.id p.id %}"
              >
                <div class="font-extrabold text-sm">
                  {{ p.title }}
                  <span class="text-xs text-stone-500">
                    · {% if p.type == "cabin" %}{% trans "Кабинка" %}{% else %}{% trans "Стол" %}{% endif %}
                    · {{ p.seats }} {% trans "мест" %}
                  </span>
                </div>

                {% if b %}
                  <div class="mt-2 text-xs text-stone-700">
                    <div><b>{% trans "Имя" %}:</b> {{ b.customer_name|default:"—" }}</div>
                    <div><b>{% trans "Тел" %}:</b> {{ b.customer_phone|default:"—" }}</div>
                    <div><b>{% trans "Гостей" %}:</b> {{ b.guests_count }}</div>
                    <div class="mt-1">
                      <span class="inline-flex px-2 py-1 rounded-lg bg-white ring-1 ring-stone-200">
                        {% if b.status == "arrived" %}{% trans "Гость пришёл" %}{% else %}{% trans "Занято" %}{% endif %}
                      </span>
                    </div>
                  </div>

                  <div class="mt-2 flex gap-2">
                    <form method="post" action="{% url 'public_site:booking_set_status' b.id 'arrived' %}">
                      {% csrf_token %}
                      <button class="px-3 py-2 rounded-xl bg-stone-900 text-white text-xs font-semibold">
                        {% trans "Гость пришёл" %}
                      </button>
                    </form>

                    <form method="post" action="{% url 'public_site:booking_set_status' b.id 'free' %}">
                      {% csrf_token %}
                      <button class="px-3 py-2 rounded-xl ring-1 ring-stone-200 bg-white text-xs font-semibold hover:bg-stone-50">
                        {% trans "Освободили" %}
                      </button>
                    </form>
                  </div>
                {% else %}
                  <form class="mt-2 grid gap-2 reserve-form hidden" method="post">
                    {% csrf_token %}
                    <input name="name" placeholder="{% trans 'Имя (необязательно)' %}"
                           class="w-full border border-stone-300 rounded-xl px-3 py-2 text-sm">
                    <input name="phone" placeholder="{% trans 'Телефон (необязательно)' %}"
                           class="w-full border border-stone-300 rounded-xl px-3 py-2 text-sm">
                    <input name="guests" type="number" min="1" value="2"
                           class="w-full border border-stone-300 rounded-xl px-3 py-2 text-sm">
                    <input name="comment" placeholder="{% trans 'Комментарий (необязательно)' %}"
                           class="w-full border border-stone-300 rounded-xl px-3 py-2 text-sm">

                    <button class="px-3 py-2 rounded-xl bg-stone-900 text-white text-xs font-semibold">
                      {% trans "Забронировать" %}
                    </button>
                  </form>

                  <button class="mt-2 px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-semibold open-reserve">
                    {% trans "Забронировать" %}
                  </button>
                {% endif %}
              </div>
            {% endwith %}
          {% endfor %}
        </div>
      </section>
    {% endfor %}
  </div>
</div>

<script>
function getCookie(name) {
  const v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
  return v ? decodeURIComponent(v.split('=')[1]) : '';
}

/* открыть форму брони в карточке */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.open-reserve');
  if (!btn) return;
  const card = btn.closest('.place');
  const form = card.querySelector('.reserve-form');
  const url = card.dataset.createUrl;

  form.action = url;
  form.classList.toggle('hidden');
});

/* drag&drop + сохранение x/y */
let drag = null;

document.addEventListener('pointerdown', (e) => {
  const el = e.target.closest('.place');
  if (!el) return;
  drag = { el, startX: e.clientX, startY: e.clientY };
  const rect = el.getBoundingClientRect();
  drag.offsetX = e.clientX - rect.left;
  drag.offsetY = e.clientY - rect.top;
  el.setPointerCapture(e.pointerId);
});

document.addEventListener('pointermove', (e) => {
  if (!drag) return;
  const plan = drag.el.parentElement.getBoundingClientRect();
  const x = e.clientX - plan.left - drag.offsetX;
  const y = e.clientY - plan.top - drag.offsetY;

  drag.el.style.left = Math.max(0, x) + 'px';
  drag.el.style.top  = Math.max(0, y) + 'px';
});

document.addEventListener('pointerup', async (e) => {
  if (!drag) return;
  const el = drag.el;
  drag = null;

  const x = parseInt(el.style.left || "0", 10);
  const y = parseInt(el.style.top  || "0", 10);

  const url = el.dataset.moveUrl;

  try {
    const resp = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify({x, y})
    });
    const data = await resp.json();
    if (!data.ok) console.error("move failed", data);
  } catch(err) {
    console.error(err);
  }
});
</script>
{% endblock %}
