{% extends "base.html" %}
{% load i18n i18n_attrs %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">
  <div class="flex items-start justify-between gap-4">
    <div>
      <h1 class="text-2xl text-white font-extrabold">{% trans "Корзина" %}</h1>
      <div class="text-stone-600 text-white text-sm mt-1">{{ branch.name }} · {{ branch.address }}</div>
    </div>
    <a href="{% url 'public_site:branch_menu' branch.id %}"
       class="px-4 py-2 rounded-xl ring-1 text-white ring-stone-200 hover:bg-stone-50">
      ← {% trans "Назад в меню" %}
    </a>
  </div>

  {% if messages %}
    <div class="mt-4 space-y-2">
      {% for m in messages %}
        <div class="rounded-xl p-3 ring-1 ring-stone-200 bg-white text-stone-800">{{ m }}</div>
      {% endfor %}
    </div>
  {% endif %}

  {% if qty_total == 0 %}
    <div class="mt-6 rounded-2xl  ring-1 text-white ring-stone-200 p-6">
      {% trans "Корзина пуста." %}
    </div>
  {% else %}
    <div class="mt-6 space-y-3">
      {% for r in rows %}
        {% with bi=r.branch_item dish=r.branch_item.item %}
        <div class="rounded-2xl bg-white ring-1 ring-stone-200 p-4 flex items-center gap-4">
          <div class="flex-1">
            <div class="font-semibold">{% t dish "name" %}</div>
            <div class="text-sm text-stone-500">{{ bi.price }} {% trans "сом" %}</div>
          </div>

          <form action="{% url 'public_site:cart_update' branch.id bi.id %}" method="post" class="flex items-center gap-2">
            {% csrf_token %}
            <input type="number" name="qty" min="0" value="{{ r.qty }}"
                   class="w-20 border border-stone-300 rounded-xl px-2 py-1 text-center">
            <button class="px-3 py-2 rounded-xl bg-stone-900 text-white">{% trans "Обновить" %}</button>
          </form>

          <form action="{% url 'public_site:cart_remove' branch.id bi.id %}" method="post">
            {% csrf_token %}
            <button class="px-3 py-2 rounded-xl ring-1 ring-stone-200 hover:bg-stone-50">
              {% trans "Удалить" %}
            </button>
          </form>

          <div class="w-28 text-right font-bold">
            {{ r.line_total }} {% trans "сом" %}
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    </div>

    <div class="mt-6 rounded-2xl bg-white ring-1 ring-stone-200 p-5">
      <div class="flex justify-between text-sm text-stone-600">
        <span>{% trans "Подытог" %}</span><span>{{ subtotal }} {% trans "сом" %}</span>
      </div>
      {% if branch.delivery_enabled %}
      <div class="flex justify-between text-sm text-stone-600 mt-2">
        <span>{% trans "Доставка" %}</span><span>{{ delivery_fee }} {% trans "сом" %}</span>
      </div>
      {% endif %}
      <div class="flex justify-between text-lg font-extrabold mt-3">
        <span>{% trans "Итого" %}</span><span>{{ total }} {% trans "сом" %}</span>
      </div>
    </div>

    <!-- Оформление -->
    <div class="mt-6 rounded-2xl bg-white ring-1 ring-stone-200 p-5">
      <h2 class="text-xl font-extrabold">{% trans "Оформление" %}</h2>

      <form action="{% url 'public_site:checkout' branch.id %}" method="post" class="mt-4 grid gap-3">
        {% csrf_token %}

        <input name="name" placeholder="{% trans 'Имя' %}"
               class="w-full border border-stone-300 rounded-xl px-3 py-2">

        <input name="phone" placeholder="{% trans 'Телефон / WhatsApp' %}"
               class="w-full border border-stone-300 rounded-xl px-3 py-2">

        {% if branch.delivery_enabled %}
          <input name="address" placeholder="{% trans 'Адрес доставки' %}"
                 class="w-full border border-stone-300 rounded-xl px-3 py-2">
          <div class="text-xs text-stone-500">
            {% trans "Минимальная сумма доставки:" %} {{ branch.min_order_amount }} {% trans "сом" %}
          </div>
        {% endif %}

        <textarea name="comment" rows="3" placeholder="{% trans 'Комментарий к заказу' %}"
                  class="w-full border border-stone-300 rounded-xl px-3 py-2"></textarea>
          <div class="grid gap-2">
  <div class="text-sm font-semibold">{% trans "Способ оплаты" %}</div>
  <label class="flex items-center gap-2">
    <input type="radio" name="payment_method" value="cash" checked>
    <span>{% trans "Наличные" %}</span>
  </label>
  <label class="flex items-center gap-2">
    <input type="radio" name="payment_method" value="online">
    <span>{% trans "Онлайн" %}</span>
  </label>
</div>
        <button class="mt-2 px-4 py-3 rounded-2xl bg-stone-900 text-white font-semibold shadow hover:bg-stone-800">
          {% if branch.delivery_enabled %}{% trans "Оформить доставку" %}{% else %}{% trans "Оформить самовывоз" %}{% endif %}
        </button>
      </form>
    </div>
  {% endif %}
</div>
{% endblock %}
