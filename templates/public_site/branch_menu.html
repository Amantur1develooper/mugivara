{% extends "base.html" %}
{% load static i18n i18n_attrs %}

{% block img %}
  <link rel="icon" type="image/jpg" sizes="32x32" href="{% static 'mini_logo.jpg' %}">
  <link rel="icon" type="image/jpg" sizes="16x16" href="{% static 'mini_logo.jpg' %}">
  <link rel="apple-touch-icon" href="{% static 'mini_logo.jpg' %}">
  <link rel="shortcut icon" href="{% static 'mini_logo.jpg' %}">
{% endblock img %}
       

{% block title %}{{ branch.name_ru }} ‚Äî –°–∞–Ω–∂–∏{% endblock %}

{% block content %}

<style>
  /* ===== Page BG (orange) ===== */
  body{
    background: radial-gradient(1200px 600px at 20% 0%, rgba(255,255,255,.18), transparent 60%),
                radial-gradient(900px 500px at 90% 10%, rgba(255,255,255,.12), transparent 55%),
                linear-gradient(180deg, #FF7A00 0%, #FF6A00 55%, #FF5A00 100%) !important;
    background-attachment: fixed !important;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  /* hide base background layer if any */
  .page-bg{ display:none !important; }

  /* ===== Helpers ===== */
  .no-scrollbar::-webkit-scrollbar{ display:none; }
  .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

  /* ===== Sticky categories (scrollspy) ===== */
  .cats-wrap{
    position: sticky;
    top: 74px; /* –ø–æ–¥ —Ç–≤–æ–π topbar, –µ—Å–ª–∏ –Ω–∞–¥–æ ‚Äî –ø–æ–¥–Ω–∏–º–∏/–æ–ø—É—Å—Ç–∏ */
    z-index: 40;
    background: rgba(255,255,255,.90);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(15,23,42,.08);
    border-left: 0;
    border-right: 0;
  }
  .cat-link{
    white-space: nowrap;
    border-radius: 999px;
    padding: 10px 14px;
    font-weight: 900;
    font-size: 13px;
    background: rgba(255,255,255,.85);
    border: 1px solid rgba(15,23,42,.14);
    color: #0f172a;
    transition: .12s ease;
  }
  .cat-link:hover{ transform: translateY(-1px); }
  .cat-link.active{
    background: #0f172a;
    border-color: #0f172a;
    color:#fff;
  }

  /* ===== Toast ===== */
  .toast-wrap{
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    z-index: 9999;
    pointer-events: none;
  }
  .toast{
    pointer-events: auto;
    background: rgba(15,23,42,.92);
    color: #fff;
    padding: 12px 14px;
    border-radius: 14px;
    box-shadow: 0 16px 40px rgba(0,0,0,.25);
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    transform: translateY(10px);
    transition: .18s ease;
    font-size: 14px;
    max-width: min(92vw, 520px);
  }
  .toast.show{ opacity:1; transform: translateY(0); }
  .toast .dot{
    width: 10px; height: 10px;
    border-radius: 999px;
    background: #22c55e;
    box-shadow: 0 0 0 6px rgba(34,197,94,.18);
  }

  /* ===== Add button animation ===== */
  .btn-anim{ position:relative; overflow:hidden; }
  .btn-anim.loading{ opacity:.85; pointer-events:none; }
  .btn-anim.loading::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(120deg, transparent, rgba(255,255,255,.35), transparent);
    transform: translateX(-100%);
    animation: shimmer .7s linear infinite;
  }
  @keyframes shimmer{ to{ transform: translateX(100%); } }
  .btn-anim.pulse{ animation: pulse .28s ease; }
  @keyframes pulse{
    0%{ transform:scale(1); }
    50%{ transform:scale(1.03); }
    100%{ transform:scale(1); }
  }

  /* ===== BIG Floating Cart ===== */
  .cart-fab{
    position: fixed;
    right: 16px;
    bottom: 16px;
    z-index: 9998;
    display: inline-flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    border-radius: 20px;
    background: rgba(15,23,42,.95);
    color: #fff;
    text-decoration:none;
    box-shadow: 0 18px 50px rgba(0,0,0,.25);
    border: 1px solid rgba(255,255,255,.14);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    transition: transform .12s ease, opacity .12s ease;
    max-width: min(92vw, 520px);
  }
  .cart-fab:hover{ transform: translateY(-2px); }
  .cart-fab.hide{ opacity:0; pointer-events:none; transform: translateY(10px); }
  .cart-icon{
    width: 44px; height: 44px;
    border-radius: 16px;
    background: rgba(255,255,255,.14);
    display:flex; align-items:center; justify-content:center;
    font-size: 20px;
    flex:0 0 auto;
  }
  .cart-badge{
    min-width: 34px;
    height: 26px;
    padding: 0 10px;
    border-radius: 999px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size: 13px;
    font-weight: 900;
    background: rgba(255,255,255,.16);
    flex:0 0 auto;
  }
  .cart-pop{ animation: cartpop .22s ease; }
  @keyframes cartpop{
    0%{ transform: scale(1); }
    60%{ transform: scale(1.12); }
    100%{ transform: scale(1); }
  }

  /* ===== Scroll to top ===== */
  .top-fab{
    position: fixed;
    right: 16px;
    bottom: 86px; /* –≤—ã—à–µ –∫–æ—Ä–∑–∏–Ω—ã */
    z-index: 9998;
    width: 52px;
    height: 52px;
    border-radius: 18px;
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(15,23,42,.14);
    box-shadow: 0 16px 40px rgba(0,0,0,.18);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size: 18px;
    font-weight: 900;
    color:#0f172a;
    cursor:pointer;
    transition: transform .12s ease, opacity .12s ease;
  }
  .top-fab:hover{ transform: translateY(-2px); }
  .top-fab.hide{ opacity:0; pointer-events:none; transform: translateY(10px); }

  /* headings scroll offset */
  .cat-section{ scroll-margin-top: 140px; }
</style>

<div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

<!-- HERO (–±–µ–∑ —Ñ–æ—Ç–æ) -->
<!-- HERO (—Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π —Ñ–∏–ª–∏–∞–ª–∞, —Ñ–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ä–∞–Ω–∂–µ–≤—ã–º) -->
<section class="max-w-6xl mx-auto px-4 pt-5 pb-4">
  <div class="rounded-3xl overflow-hidden shadow-xl ring-1 ring-black/5 bg-white">
    <div class="flex flex-col md:flex-row">

      {% if branch.cover_photo %}
      <!-- Cover photo -->
      <div class="relative md:order-2 md:w-[360px] lg:w-[420px]">
        <img
          src="{{ branch.cover_photo.url }}"
          alt="{{ branch.name }}"
          loading="lazy"
          decoding="async"
          class="w-full object-cover aspect-[16/9] md:aspect-auto md:h-full md:min-h-[240px]"
        >
        <!-- –ª—ë–≥–∫–∞—è —Ç–æ–Ω–∏—Ä–æ–≤–∫–∞ —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ -->
        <div class="absolute inset-0 bg-gradient-to-t from-black/25 via-black/0 to-black/0"></div>

        <!-- –ø–æ–¥–ø–∏—Å—å –Ω–∞ —Ñ–æ—Ç–æ (–ø–æ –∂–µ–ª–∞–Ω–∏—é) -->
        <div class="absolute left-4 bottom-4 right-4">
          <div class="text-white font-extrabold text-lg drop-shadow">
            {{ branch.name }}
          </div>
          <div class="text-white/90 text-xs mt-1 line-clamp-2 drop-shadow">
            {{ branch.address }}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Text -->
      <div class="p-4 md:p-7 flex-1">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-stone-900">
              {{ branch.name_ru }}
            </h1>
            <div class="mt-2 text-sm text-stone-600">
              {{ branch.address }}
              {% if branch.delivery_enabled %}
                ¬∑ {% trans "–î–æ—Å—Ç–∞–≤–∫–∞" %}: {% trans "–ú–∏–Ω." %} {{ branch.min_order_amount }} ¬∑ {% trans "–î–æ—Å—Ç." %} {{ branch.delivery_fee }}
              {% else %}
                ¬∑ {% trans "–°–∞–º–æ–≤—ã–≤–æ–∑" %}
              {% endif %}
            </div>
          </div>

          <!-- –≤–µ—Ä—Ö–Ω—è—è –∫–æ—Ä–∑–∏–Ω–∞ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å) -->
          <a href="{% url 'public_site:cart_detail' branch.id %}"
             class="hidden sm:inline-flex items-center gap-2 px-4 py-3 rounded-2xl bg-stone-900 text-white font-semibold shadow hover:bg-stone-800">
            {% trans "–ö–æ—Ä–∑–∏–Ω–∞" %}
            <span class="px-2 py-1 rounded-xl bg-white/15 text-xs" data-cart-qty>{{ cart_qty }}</span>
            <span class="hidden md:inline" data-cart-total>¬∑ {{ cart_total }} {% trans "—Å–æ–º" %}</span>
          </a>
        </div>

        {% if branch.cover_photo %}
          <div class="mt-4 text-xs text-stone-500">
            {% trans "–§–æ—Ç–æ —Ñ–∏–ª–∏–∞–ª–∞" %}: {{ branch.name_ru }}
          </div>
        {% endif %}
      </div>

    </div>
  </div>
</section>


<!-- Sticky categories (with active highlight) -->
<div class="cats-wrap">
  <div class="max-w-6xl mx-auto px-3 py-2 overflow-x-auto no-scrollbar" id="catsBar">
    <div class="flex gap-2 md:gap-3" id="catsLinks">
      <a href="#menu" class="cat-link active" data-cat-link="menu">{% trans "–í—Å–µ" %}</a>
      {% for c in menu %}
        <a href="#cat-{{ c.branch_category.id }}"
           class="cat-link"
           data-cat-link="cat-{{ c.branch_category.id }}">
          {% t c.branch_category.category "name" %}
        </a>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Menu -->
<section id="menu" class="max-w-6xl mx-auto px-4 py-6">
  {% for c in menu %}
    <section id="cat-{{ c.branch_category.id }}" class="mb-10 cat-section" data-cat-section="cat-{{ c.branch_category.id }}">
      <div class="flex items-center gap-3 mb-4">
        <div class="flex-1 h-px bg-white/55"></div>
        <h2 class="text-xl md:text-2xl text-white font-extrabold tracking-wide">
          {% t c.branch_category.category "name" %}
        </h2>
        <div class="flex-1 h-px bg-white/55"></div>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-5">
        {% for row in c.items %}
          {% with bi=row.branch_item dish=row.branch_item.item %}
          <article class="group relative overflow-hidden rounded-3xl bg-white ring-1 ring-black/5 shadow-lg flex flex-col">
            {% if dish.photo %}
              <img src="{{ dish.photo.url }}"
                   alt="{% t dish 'name' %}"
                   loading="lazy"
                   decoding="async"
                   width="480" height="320"
                   class="aspect-[4/3] w-full object-cover transition group-hover:scale-[1.03]">
            {% endif %}

            <div class="p-3 md:p-4 flex-1 flex flex-col">
              <div class="min-h-[48px]">
                <h3 class="text-base md:text-lg font-semibold leading-snug">{% t dish "name" %}</h3>

                {% t dish "description" as desc %}
                {% if desc %}
                  <div class="text-sm text-stone-500 mt-0.5 line-clamp-2">{{ desc }}</div>
                {% endif %}
              </div>

              <div class="mt-3 md:mt-4 flex items-end justify-between gap-3">
                <div>
                  <div class="text-xs text-stone-400">{% trans "–¶–µ–Ω–∞" %}</div>
                  <div class="text-lg md:text-xl font-extrabold">{{ bi.price }} {% trans "—Å–æ–º" %}</div>
                </div>

                <!-- add to cart (–±–µ–∑ qty=1 –∏–Ω–ø—É—Ç–∞) -->
                <form action="{% url 'public_site:add_to_cart' bi.id %}"
                      method="post"
                      class="flex items-center justify-end"
                      data-add-to-cart>
                  {% csrf_token %}
                  <button type="submit"
                          class="btn-anim inline-flex items-center justify-center whitespace-nowrap px-4 py-2 rounded-2xl text-white text-sm md:text-[15px] font-extrabold shadow-md hover:shadow-lg transition"
                          style="background:#0f172a">
                    +{% trans "" %}
                  </button>
                </form>
              </div>
            </div>
          </article>
          {% endwith %}
        {% endfor %}
      </div>
    </section>
  {% endfor %}
</section>

<!-- BIG floating cart -->
<a id="cartFab"
   href="{% url 'public_site:cart_detail' branch.id %}"
   class="cart-fab {% if cart_qty|default:0 == 0 %}hide{% endif %}">
  <span class="cart-icon">üß∫</span>
  <span class="cart-badge" data-cart-qty>{{ cart_qty }}</span>
  <span class="hidden sm:inline" data-cart-total>¬∑ {{ cart_total }} {% trans "—Å–æ–º" %}</span>
</a>

<!-- Scroll to top -->
<button id="toTopFab" class="top-fab hide" type="button" aria-label="–ù–∞–≤–µ—Ä—Ö">‚Üë</button>

<script>
  function getCookie(name) {
    const v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return v ? decodeURIComponent(v.split('=')[1]) : '';
  }

  function showToast(message){
    const wrap = document.getElementById('toastWrap');
    const el = document.createElement('div');
    el.className = 'toast';
    el.innerHTML = `<span class="dot"></span><div>${message}</div>`;
    wrap.appendChild(el);
    requestAnimationFrame(() => el.classList.add('show'));
    setTimeout(() => {
      el.classList.remove('show');
      setTimeout(() => el.remove(), 220);
    }, 1400);
  }

  function updateCartUI(qty, total){
    const qNum = Number(qty) || 0;

    document.querySelectorAll('[data-cart-qty]').forEach(el => {
      el.textContent = qNum;
      el.classList.remove('cart-pop');
      void el.offsetWidth;
      el.classList.add('cart-pop');
    });

    document.querySelectorAll('[data-cart-total]').forEach(el => {
      el.textContent = `¬∑ ${total} —Å–æ–º`;
    });

    const fab = document.getElementById('cartFab');
    if (fab) fab.classList.toggle('hide', qNum <= 0);
  }

  // stop card click bubbling if any
  document.addEventListener('click', (e) => {
    if (e.target.closest('form[data-add-to-cart]')) e.stopPropagation();
  }, true);

  // add-to-cart AJAX
  document.addEventListener('submit', async (e) => {
    const form = e.target.closest('form[data-add-to-cart]');
    if (!form) return;

    e.preventDefault();
    e.stopPropagation();

    const btn = form.querySelector('button[type="submit"]');
    if (btn) btn.classList.add('btn-anim','loading');

    try {
      const resp = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken'),
        }
      });

      const data = await resp.json();

      if (data.ok) {
        updateCartUI(data.qty, data.total);
        if (btn){
          btn.classList.remove('loading');
          btn.classList.add('pulse');
          setTimeout(()=>btn.classList.remove('pulse'), 300);
        }
        showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É ‚úÖ');
      } else {
        showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å ‚ùå');
      }
    } catch (err) {
      console.error(err);
      showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ / —Å–µ—Ä–≤–µ—Ä–∞ ‚ùå');
    } finally {
      if (btn) btn.classList.remove('loading');
    }
  }, true);

  // ===== Scroll to top button =====
  (function(){
    const topBtn = document.getElementById('toTopFab');
    if (!topBtn) return;

    const onScroll = () => {
      const show = window.scrollY > 500;
      topBtn.classList.toggle('hide', !show);
    };
    window.addEventListener('scroll', onScroll, { passive:true });
    onScroll();

    topBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  })();

  // ===== Categories scrollspy (highlight current section) =====
  (function(){
    const bar = document.getElementById('catsBar');
    const links = Array.from(document.querySelectorAll('[data-cat-link]'));
    const sections = Array.from(document.querySelectorAll('[data-cat-section]'));

    if (!links.length || !sections.length) return;

    const setActive = (id) => {
      links.forEach(a => {
        const isActive = a.dataset.catLink === id;
        a.classList.toggle('active', isActive);
        if (isActive) {
          a.setAttribute('aria-current', 'true');
          // —á—Ç–æ–±—ã –ø–æ–ª–æ—Å–∞ "–¥–≤–∏–≥–∞–ª–∞—Å—å" –∏ –∞–∫—Ç–∏–≤–Ω—ã–π –ø—É–Ω–∫—Ç –±—ã–ª –≤–∏–¥–µ–Ω
          a.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        } else {
          a.removeAttribute('aria-current');
        }
      });
    };

    // click -> set active instantly
    links.forEach(a => {
      a.addEventListener('click', () => setActive(a.dataset.catLink));
    });

    // –µ—Å–ª–∏ –≤ —Å–∞–º–æ–º –≤–µ—Ä—Ö—É ‚Äî –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º "–í—Å–µ"
    const menuEl = document.getElementById('menu');
    const first = sections[0];

    const observer = new IntersectionObserver((entries) => {
      // –≤—ã–±–µ—Ä–µ–º —Å–∞–º—É—é "–≤–∏–¥–∏–º—É—é" —Å–µ–∫—Ü–∏—é
      const visible = entries
        .filter(e => e.isIntersecting)
        .sort((a,b) => (b.intersectionRatio - a.intersectionRatio));

      if (visible.length) {
        const id = visible[0].target.getAttribute('data-cat-section');
        setActive(id);
      }
    }, {
      root: null,
      // —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤ –º–µ–Ω—è–ª—Å—è, –∫–æ–≥–¥–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ —ç–∫—Ä–∞–Ω–∞
      rootMargin: '-25% 0px -65% 0px',
      threshold: [0.05, 0.15, 0.25, 0.35, 0.5]
    });

    sections.forEach(s => observer.observe(s));

    // –¥–æ–ø. –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –≤—ã—à–µ –ø–µ—Ä–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –∞–∫—Ç–∏–≤ "–í—Å–µ"
    const onScroll = () => {
      if (!first || !menuEl) return;
      const y = window.scrollY || 0;
      const firstTop = first.getBoundingClientRect().top + y;
      if (y < firstTop - 180) setActive('menu');
    };
    window.addEventListener('scroll', onScroll, { passive:true });
    onScroll();
  })();
</script>

{% endblock %}
{% block footer %}
     <a href="{% url 'public_site:home' %}">–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ Amantur agency
</a>
{% endblock footer %}