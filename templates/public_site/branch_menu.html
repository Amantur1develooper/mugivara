{% extends "base.html" %}
{% load static i18n i18n_attrs %}
{% block img %}
  <link rel="icon" type="image/jpg" sizes="32x32" href="{% static 'mini_logo.jpg' %}">
  <link rel="icon" type="image/jpg" sizes="16x16" href="{% static 'mini_logo.jpg' %}">
  <link rel="apple-touch-icon" href="{{ branch.cover_photo.url }}' %}">
  <link rel="shortcut icon" href="{{ branch.cover_photo.url }}">
{% endblock img %}
{% block content %}
<style>  body{
    background:url("{{ branch.cover_photo.url }}") center / cover no-repeat fixed; 
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }</style>
<div class="min-h-[85vh]">

  <style>
  /* ... —Ç–≤–æ–∏ —Å—Ç–∏–ª–∏ ... */

  /* Floating Cart */
  .cart-fab{
    position: fixed;
    right: 18px;
    bottom: 18px;
    z-index: 9998;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
    border-radius: 999px;
    background: rgba(15,23,42,.95);
    color: #fff;
    box-shadow: 0 16px 40px rgba(0,0,0,.25);
    border: 1px solid rgba(255,255,255,.12);
    backdrop-filter: blur(10px);
  }
  .cart-fab:hover{ opacity:.95; }
  .cart-fab.hide{ display:none; }

  .cart-badge{
    min-width: 26px;
    height: 22px;
    padding: 0 8px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 800;
    background: rgba(255,255,255,.16);
  }
  .cart-pop{ animation: cartpop .22s ease; }
  @keyframes cartpop{
    0%{ transform: scale(1); }
    60%{ transform: scale(1.12); }
    100%{ transform: scale(1); }
  }
</style>


<style>
  
  /* Toast */
  .toast-wrap{
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    z-index: 9999;
    pointer-events: none;
  }
  .toast{
    pointer-events: auto;
    background: rgba(15,23,42,.92);
    color: #fff;
    padding: 12px 14px;
    border-radius: 14px;
    box-shadow: 0 16px 40px rgba(0,0,0,.25);
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    transform: translateY(10px);
    transition: .18s ease;
    font-size: 14px;
    max-width: min(92vw, 520px);
  }
  .toast.show{
    opacity: 1;
    transform: translateY(0);
  }
  .toast .dot{
    width: 10px; height: 10px;
    border-radius: 999px;
    background: #22c55e;
    box-shadow: 0 0 0 6px rgba(34,197,94,.18);
  }

  /* Button animation */
  .btn-anim{
    position: relative;
    overflow: hidden;
  }
  .btn-anim.loading{
    opacity: .85;
    pointer-events: none;
  }
  .btn-anim.loading::after{
    content:"";
    position:absolute;
    inset:0;
    background: linear-gradient(120deg, transparent, rgba(255,255,255,.35), transparent);
    transform: translateX(-100%);
    animation: shimmer .7s linear infinite;
  }
  @keyframes shimmer{
    to{ transform: translateX(100%); }
  }
  .btn-anim.pulse{
    animation: pulse .28s ease;
  }
  @keyframes pulse{
    0%{ transform: scale(1); }
    50%{ transform: scale(1.03); }
    100%{ transform: scale(1); }
  }
  
</style>

<div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

<script>
  const fab = document.getElementById('cartFab');
if (fab) fab.classList.remove('hide');

  function getCookie(name) {
    const v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return v ? decodeURIComponent(v.split('=')[1]) : '';
  }

  function showToast(message){
    const wrap = document.getElementById('toastWrap');
    const el = document.createElement('div');
    el.className = 'toast';
    el.innerHTML = `<span class="dot"></span><div>${message}</div>`;
    wrap.appendChild(el);
    requestAnimationFrame(() => el.classList.add('show'));
    setTimeout(() => {
      el.classList.remove('show');
      setTimeout(() => el.remove(), 220);
    }, 1400);
  }
function updateCartUI(qty, total){
  // qty / total –º–æ–≥—É—Ç –ø—Ä–∏–π—Ç–∏ —Å—Ç—Ä–æ–∫–æ–π ‚Äî –ø—Ä–∏–≤–µ–¥—ë–º
  const qNum = Number(qty) || 0;

  document.querySelectorAll('[data-cart-qty]').forEach(el => {
    el.textContent = qNum;
    el.classList.remove('cart-pop');
    void el.offsetWidth; // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏
    el.classList.add('cart-pop');
  });

  document.querySelectorAll('[data-cart-total]').forEach(el => {
    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ
    el.textContent = `¬∑ ${total} —Å–æ–º`;
  });

  const fab = document.getElementById('cartFab');
  if (fab){
    fab.classList.toggle('hide', qNum <= 0);
  }
}


  // –∑–∞—â–∏—Ç–∞ –æ—Ç –∫–ª–∏–∫–∞ –ø–æ —Ä–æ–¥–∏—Ç–µ–ª—è–º (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –∫–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è)
  document.addEventListener('click', (e) => {
    if (e.target.closest('form[data-add-to-cart]')) e.stopPropagation();
  }, true);

  document.addEventListener('submit', async (e) => {
    const form = e.target.closest('form[data-add-to-cart]');
    if (!form) return;

    e.preventDefault();
    e.stopPropagation();

    const btn = form.querySelector('button[type="submit"]');
    if (btn){
      btn.classList.add('btn-anim','loading');
    }

    try {
      const resp = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken'),
        }
      });

      const data = await resp.json();

      if (data.ok) {
        updateCartUI(data.qty, data.total);
        if (btn){
          btn.classList.remove('loading');
          btn.classList.add('pulse');
          setTimeout(()=>btn.classList.remove('pulse'), 300);
        }
        showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É ‚úÖ');
      } else {
        showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å ‚ùå');
      }
    } catch (err) {
      console.error(err);
      showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ / —Å–µ—Ä–≤–µ—Ä–∞ ‚ùå');
    } finally {
      if (btn){
        btn.classList.remove('loading');
      }
    }
  }, true);
</script>

  <!-- HERO -->
 <section class="max-w-6xl mx-auto px-4 pt-6 pb-4">
  <div class="rounded-2xl overflow-hidden shadow-xl ring-1 ring-black/5">
    <div class="relative p-4 md:p-7 bg-white"
         {% if branch.cover_photo %}
         style="background-image:url('{{ branch.cover_photo.url }}'); background-size:cover; background-position:center;"
         {% endif %}>
      
      {% if branch.cover_photo %}
        <div class="absolute inset-0 bg-black/35"></div>
      {% endif %}

      <div class="relative flex items-start justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight {% if branch.cover_photo %}text-white{% endif %}">
            {{ branch.name }}
          </h1>
          <div class="mt-2 text-sm {% if branch.cover_photo %}text-white/90{% else %}text-stone-600{% endif %}">
            {{ branch.address }}
            {% if branch.delivery_enabled %}
              ¬∑ {% trans "–î–æ—Å—Ç–∞–≤–∫–∞" %}: {% trans "–ú–∏–Ω." %} {{ branch.min_order_amount }} ¬∑ {% trans "–î–æ—Å—Ç." %} {{ branch.delivery_fee }}
            {% else %}
              ¬∑ {% trans "–°–∞–º–æ–≤—ã–≤–æ–∑" %}
            {% endif %}
          </div>
        </div>

        <a href="{% url 'public_site:cart_detail' branch.id %}"
           class="inline-flex items-center gap-2 px-4 py-3 rounded-2xl bg-stone-900 text-white font-semibold shadow hover:bg-stone-800">
          {% trans "–ö–æ—Ä–∑–∏–Ω–∞" %}
          <span class="px-2 py-1 rounded-xl bg-white/15 text-xs" data-cart-qty>{{ cart_qty }}</span>
<span class="hidden sm:inline" data-cart-total>¬∑ {{ cart_total }} {% trans "—Å–æ–º" %}</span>

        </a>
      </div>
    </div>
  </div>
</section>


  <!-- –õ–∏–ø–∫–∞—è –ø–æ–ª–æ—Å–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
  <div class="sticky top-[56px] z-40 bg-white/95 backdrop-blur border-y border-stone-200">
    <div class="max-w-6xl mx-auto px-3 py-2 overflow-x-auto no-scrollbar">
      <div class="flex gap-2 md:gap-3">
        <a href="#menu" class="px-3 py-2 rounded-xl bg-stone-900 text-white text-sm">{% trans "–í—Å–µ" %}</a>
        {% for c in menu %}
          <a href="#cat-{{ c.branch_category.id }}"
             class="px-3 py-2 rounded-xl bg-white ring-1 ring-stone-300 text-stone-800 text-sm hover:bg-stone-50">
            {% t c.branch_category.category "name" %}
          </a>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- –ú–µ–Ω—é -->
  <section id="menu" class="max-w-6xl mx-auto  py-6">
    {% for c in menu %}
      <section id="cat-{{ c.branch_category.id }}" class="mb-10 scroll-mt-24">
        <div class="flex items-center gap-3 mb-4">
          <div class="flex-1 h-px bg-stone-300"></div>
          <h2 class="text-xl md:text-2xl text-white font-semibold tracking-wide text-white">
            {% t c.branch_category.category "name" %}
          </h2>
          <div class="flex-1 h-px bg-stone-300"></div>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-5">
          {% for row in c.items %}
            {% with bi=row.branch_item dish=row.branch_item.item %}
            <article class="group relative overflow-hidden rounded-3xl bg-white ring-1 ring-black/5 shadow-lg flex flex-col">
              <!-- –§–æ—Ç–æ -->
              {% if dish.photo %}
             
     
     

                <img src="{{ dish.photo.url }}"
                     alt="{% t dish 'name' %}"
                     loading="lazy"
     decoding="async"
     width="480" height="320"
                     class="aspect-[4/3] w-full object-cover transition group-hover:scale-[1.03]"
                     decoding="async">
              {% endif %}

              <div class="p-3 md:p-4 flex-1 flex flex-col">
                <div class="min-h-[48px]">
                  <h3 class="text-base md:text-lg font-semibold leading-snug">
  {% t dish "name" %}
</h3>

{% t dish "description" as desc %}
{% if desc %}
  <div class="text-sm text-stone-500 mt-0.5 line-clamp-2">{{ desc }}</div>
{% endif %}

                 
                </div>

                <div class="mt-3 md:mt-4 grid grid-cols-1 sm:grid-cols-[auto_1fr] gap-2 items-end">
                  <div>
                    <div class="text-xs text-stone-400">{% trans "–¶–µ–Ω–∞" %}</div>
                    <div class="text-lg md:text-xl font-bold">{{ bi.price }} {% trans "—Å–æ–º" %}</div>
                  </div>

                  <!-- –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É -->
                  <form action="{% url 'public_site:add_to_cart' bi.id %}" method="post"
                        class="flex items-center justify-end gap-2 flex-wrap" data-add-to-cart>
                    {% csrf_token %}
                    <input type="number" name="qty" value="1" min="1"
                           class="w-12 sm:w-16 border border-stone-300 rounded-xl px-2 py-1 text-center focus:outline-none focus:ring-2 focus:ring-stone-400">
                    <button type="submit"
                            class="btn-anim inline-flex items-center justify-center whitespace-nowrap px-3 md:px-4 py-2 rounded-xl text-white text-sm md:text-[15px] font-medium shadow-md hover:shadow-lg transition"
                            style="background:#25D366">
                      {% trans "–í –∫–æ—Ä–∑–∏–Ω—É" %}
                    </button>
                  </form>
                </div>
              </div>
            </article>
            {% endwith %}
          {% endfor %}
        </div>
      </section>
    {% endfor %}
  </section>
<a id="cartFab"
   href="{% url 'public_site:cart_detail' branch.id %}"
   class="cart-fab {% if cart_qty|default:0 == 0 %}hide{% endif %}">
  üß∫
  <span class="cart-badge" data-cart-qty>{{ cart_qty }}</span>
  <span class="hidden sm:inline" data-cart-total>¬∑ {{ cart_total }} {% trans "—Å–æ–º" %}</span>
</a>

  <!-- –ù–∏–∂–Ω–∏–π –±–∞–Ω–Ω–µ—Ä -->
  <section class="max-w-6xl mx-auto px-4 pb-10">
    <div class="rounded-3xl bg-stone-900 text-white p-5 md:p-7 flex flex-col sm:flex-row items-start sm:items-center gap-4 shadow-xl">
      <div class="text-lg md:text-xl font-semibold">{% trans "–ì–æ—Ç–æ–≤—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?" %}</div>
      <div class="flex-1 text-sm text-stone-200">{% trans "–°–æ–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É ‚Äî –∏ –æ—Ñ–æ—Ä–º–∏—Ç–µ –¥–æ—Å—Ç–∞–≤–∫—É/—Å–∞–º–æ–≤—ã–≤–æ–∑." %}</div>
      <a href="{% url 'public_site:cart_detail' branch.id %}" class="px-4 py-3 rounded-2xl bg-white text-stone-900 font-semibold shadow">
        {% trans "–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É" %} ({{ cart_qty }})
      </a>
    </div>
  </section>

</div>
<script>
  function getCookie(name) {
    const v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return v ? decodeURIComponent(v.split('=')[1]) : '';
  }

  // –í–ê–ñ–ù–û: –µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞/—Ñ–æ—Ä–º–∞ –≤–Ω—É—Ç—Ä–∏ <a> (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏) ‚Äî
  // –Ω—É–∂–Ω–æ –≥–∞—Å–∏—Ç—å click, –∏–Ω–∞—á–µ –±—Ä–∞—É–∑–µ—Ä –ø–µ—Ä–µ–π–¥–µ—Ç –ø–æ —Å—Å—ã–ª–∫–µ.
  document.addEventListener('click', (e) => {
    if (e.target.closest('form[data-add-to-cart]')) {
      e.stopPropagation();
    }
  }, true);

  document.addEventListener('submit', async (e) => {
    const form = e.target.closest('form[data-add-to-cart]');
    if (!form) return;

    e.preventDefault();
    e.stopPropagation();

    const btn = form.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;

    try {
      const resp = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken'),
        }
      });

      const data = await resp.json();

      if (data.ok) {
        // –µ—Å–ª–∏ –µ—Å—Ç—å –±–µ–π–¥–∂ –∫–æ—Ä–∑–∏–Ω—ã ‚Äî –æ–±–Ω–æ–≤–∏
        const badge = document.querySelector('[data-cart-badge]');
        if (badge) badge.textContent = data.qty;

        // –º–∏–Ω–∏-—Ñ–∏–¥–±–µ–∫ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∫—Ä–∞—Å–∏–≤—ã–π toast)
        btn && (btn.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–æ ‚úì');
        setTimeout(() => { if (btn) btn.textContent = '–í –∫–æ—Ä–∑–∏–Ω—É'; }, 700);
      } else {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É');
      }
    } catch (err) {
      console.error(err);
      alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ / —Å–µ—Ä–≤–µ—Ä–∞');
    } finally {
      if (btn) btn.disabled = false;
    }
  }, true);
</script>

{% endblock %}
