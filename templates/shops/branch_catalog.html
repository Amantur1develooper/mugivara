{% extends "base.html" %}
{% load i18n static %}

{% block title %}{{ branch.name_ru }} ‚Äî {{ store.name_ru }}{% endblock %}

{% block content %}
<style>
  /* –æ—Ä–∞–Ω–∂–µ–≤—ã–π —Ñ–æ–Ω –ø–æ–¥ –Ω–∞—à —à–∞–±–ª–æ–Ω (base —É–∂–µ –æ—Ä–∞–Ω–∂–µ–≤—ã–π, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π) */
  body{
    background: radial-gradient(1200px 600px at 20% 0%, rgba(255,255,255,.18), transparent 60%),
                radial-gradient(900px 500px at 90% 10%, rgba(255,255,255,.12), transparent 55%),
                linear-gradient(180deg, #FF7A00 0%, #FF6A00 55%, #FF5A00 100%) !important;
    background-attachment: fixed !important;
  }

  /* hide scrollbars in categories */
  .no-scrollbar::-webkit-scrollbar{ display:none; }
  .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

  /* cart fab bigger */
  .shop-cart-fab{
    position: fixed;
    right: 16px;
    bottom: 16px;
    z-index: 9998;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 14px 16px;
    border-radius: 20px;
    background: rgba(15,23,42,.95);
    color: #fff;
    text-decoration:none;
    box-shadow: 0 18px 55px rgba(0,0,0,.28);
    border: 1px solid rgba(255,255,255,.12);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    max-width: min(92vw, 420px);
    transition: transform .12s ease, opacity .12s ease, box-shadow .12s ease;
  }
  .shop-cart-fab:hover{ transform: translateY(-2px); box-shadow: 0 22px 60px rgba(0,0,0,.30); }
  .shop-cart-fab.hide{ opacity:0; pointer-events:none; transform: translateY(10px); }

  .shop-cart-fab__icon{
    width: 44px; height: 44px;
    border-radius: 16px;
    background: rgba(255,255,255,.12);
    display:flex; align-items:center; justify-content:center;
    flex: 0 0 auto;
    font-size: 20px;
  }
  .shop-cart-fab__badge{
    padding: 7px 10px;
    border-radius: 999px;
    background: rgba(255,255,255,.14);
    font-weight: 900;
    font-size: 12px;
    min-width: 30px;
    text-align:center;
    flex:0 0 auto;
  }
  .cart-pop{ animation: cartpop .22s ease; }
  @keyframes cartpop{ 0%{transform:scale(1)} 60%{transform:scale(1.12)} 100%{transform:scale(1)} }

  /* scroll to top btn */
  .to-top{
    position: fixed;
    right: 16px;
    bottom: 86px;
    z-index: 9997;
    width: 52px; height: 52px;
    border-radius: 18px;
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(15,23,42,.10);
    box-shadow: 0 14px 40px rgba(0,0,0,.18);
    display: inline-flex;
    align-items:center;
    justify-content:center;
    text-decoration:none;
    font-size: 18px;
    transition: transform .12s ease, opacity .12s ease;
    opacity: 0;
    pointer-events: none;
  }
  .to-top.show{ opacity: 1; pointer-events: auto; }
  .to-top:hover{ transform: translateY(-2px); }

  /* active category pill */
  .cat-pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 10px 14px;
    border-radius: 999px;
    background: rgba(255,255,255,.92);
    color:#0f172a;
    font-weight: 900;
    font-size: 13px;
    border: 1px solid rgba(15,23,42,.10);
    white-space: nowrap;
    transition: .12s ease;
  }
  .cat-pill:hover{ transform: translateY(-1px); }
  .cat-pill.active{
    background: rgba(15,23,42,.95);
    color: #fff;
    border-color: rgba(255,255,255,.12);
  }

  /* toast */
  .toast-wrap{
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    z-index: 9999;
    pointer-events:none;
  }
  .toast{
    pointer-events:auto;
    background: rgba(15,23,42,.92);
    color:#fff;
    padding: 12px 14px;
    border-radius: 14px;
    box-shadow: 0 16px 40px rgba(0,0,0,.25);
    display:flex;
    align-items:center;
    gap:10px;
    opacity:0;
    transform: translateY(10px);
    transition: .18s ease;
    font-size: 14px;
    max-width: min(92vw, 520px);
  }
  .toast.show{ opacity:1; transform: translateY(0); }
  .toast .dot{
    width:10px;height:10px;border-radius:999px;
    background:#22c55e;
    box-shadow: 0 0 0 6px rgba(34,197,94,.18);
  }
</style>

<div class="max-w-6xl mx-auto px-4 py-6">

  <!-- HERO -->
  <section class="rounded-3xl overflow-hidden ring-1 ring-white/20 shadow-[0_18px_55px_rgba(0,0,0,.18)]">
    <div class="relative bg-white/10 backdrop-blur p-5 sm:p-7">
      <div class="absolute inset-0 pointer-events-none"
           style="background: radial-gradient(circle at 15% 10%, rgba(255,255,255,.18), transparent 55%),
                               radial-gradient(circle at 90% 20%, rgba(255,255,255,.12), transparent 50%);"></div>

      <div class="relative flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex items-center gap-3 min-w-0">
          <!-- avatar -->
          <div class="w-14 h-14 rounded-full overflow-hidden ring-2 ring-white/50 bg-white/80 flex items-center justify-center flex-shrink-0">
            {% if branch.cover_photo %}
              <img src="{{ branch.cover_photo.url }}" alt="" class="w-full h-full object-cover" loading="lazy" decoding="async">
            {% else %}
              <span class="font-extrabold text-stone-700">{{ branch.name_ru|slice:":1" }}</span>
            {% endif %}
          </div>

          <div class="min-w-0">
            <div class="text-white/80 text-xs font-semibold">
              {{ store.name_ru }} ¬∑
              {% if mode == "delivery" %}üöö {% trans "–î–æ—Å—Ç–∞–≤–∫–∞" %}{% else %}üè¨ {% trans "–í –º–∞–≥–∞–∑–∏–Ω–µ" %}{% endif %}
            </div>

            <h1 class="text-white text-2xl sm:text-3xl font-extrabold truncate">
              {{ branch.name_ru }}
            </h1>
            <div class="text-white/85 text-sm mt-1 truncate">{{ branch.address }}</div>

            {% if mode == "delivery" and branch.delivery_enabled %}
              <div class="text-white/70 text-xs mt-1">
                {% trans "–ú–∏–Ω." %} {{ branch.min_order_amount }} ¬∑ {% trans "–î–æ—Å—Ç–∞–≤–∫–∞" %} {{ branch.delivery_fee }} {% trans "—Å–æ–º" %}
              </div>
            {% endif %}
          </div>
        </div>

        <div class="flex flex-wrap gap-2">
          {% if branch.phone %}
            <a href="tel:{{ branch.phone }}"
               class="px-4 py-3 rounded-2xl bg-white/90 text-stone-900 font-extrabold ring-1 ring-white/25">
              üìû {% trans "–ü–æ–∑–≤–æ–Ω–∏—Ç—å" %}
            </a>
            <a href="https://wa.me/{{ branch.phone|cut:'+'|cut:' '|cut:'-'|cut:'('|cut:')' }}"
               target="_blank"
               class="px-4 py-3 rounded-2xl text-white font-extrabold"
               style="background:#25D366;">
              WhatsApp
            </a>
          {% endif %}

          <a href="{% url 'shops:cart_detail' branch.id %}"
             class="px-4 py-3 rounded-2xl bg-stone-950/80 text-white font-extrabold ring-1 ring-white/20">
            üß∫ {% trans "–ö–æ—Ä–∑–∏–Ω–∞" %}
            <span class="ml-2 inline-flex items-center justify-center px-2 py-1 rounded-xl bg-white/15 text-xs" data-cart-qty>{{ cart_qty }}</span>
            <span class="hidden sm:inline text-white/80 ml-1" data-cart-total>¬∑ {{ cart_total }} {% trans "—Å–æ–º" %}</span>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- sticky categories -->
  <div class="sticky top-[56px] z-40 mt-4 rounded-2xl bg-white/92 backdrop-blur ring-1 ring-black/10 shadow-sm">
    <div class="px-3 py-2 overflow-x-auto no-scrollbar">
      <div class="flex gap-2" id="catBar">
        <a class="cat-pill active" href="#cat-all" data-cat-link="cat-all">{% trans "–í—Å–µ" %}</a>
        {% for c in categories %}
          <a class="cat-pill"
             href="#cat-{{ c.id }}"
             data-cat-link="cat-{{ c.id }}">
            {{ c.name_ru }}
          </a>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- PRODUCTS -->
  <section id="cat-all" class="mt-5 scroll-mt-28">
    {% for c in categories %}
      <section id="cat-{{ c.id }}" class="mb-10 scroll-mt-28 cat-section">
        <div class="flex items-center gap-3 mb-4">
          <div class="flex-1 h-px bg-white/35"></div>
          <h2 class="text-white text-lg sm:text-xl font-extrabold tracking-wide">
            {{ c.name_ru }}
          </h2>
          <div class="flex-1 h-px bg-white/35"></div>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4">
          {% for s in stocks %}
            {% if s.product.category_id == c.id %}
              <article class="rounded-3xl overflow-hidden bg-white ring-1 ring-black/5 shadow-[0_12px_35px_rgba(0,0,0,.10)] flex flex-col">
                {% if s.product.photo %}
                  <img src="{{ s.product.photo.url }}"
                       alt="{{ s.product.name_ru }}"
                       class="aspect-[4/3] w-full object-cover"
                       loading="lazy" decoding="async">
                {% endif %}

                <div class="p-3 sm:p-4 flex-1 flex flex-col">
                  <div class="min-h-[46px]">
                    <div class="font-extrabold text-stone-900 leading-snug">
                      {{ s.product.name_ru }}
                    </div>
                    {% if s.product.description_ru %}
                      <div class="text-xs text-stone-500 mt-1 line-clamp-2">{{ s.product.description_ru }}</div>
                    {% endif %}
                  </div>

                  <div class="mt-3 flex items-end justify-between gap-2">
                    <div>
                      <div class="text-[11px] text-stone-400">{% trans "–¶–µ–Ω–∞" %}</div>
                      <div class="text-lg font-extrabold text-stone-900">
                        {{ s.product.price }} {% trans "—Å–æ–º" %}
                      </div>

                      <div class="text-[11px] text-stone-500 mt-1">
                        {% trans "–í –Ω–∞–ª–∏—á–∏–∏" %}: <b>{{ s.qty }}</b> {{ s.product.unit }}
                      </div>
                    </div>

                    <!-- Add to cart (qty=1 no input) -->
                    <form action="{% url 'shops:cart_add' branch.id s.product.id %}" method="post" data-add-to-cart class="flex">
                      {% csrf_token %}
                      <input type="hidden" name="qty" value="1">
                      <button type="submit"
                              class="inline-flex items-center justify-center px-3 sm:px-4 py-2.5 rounded-2xl text-white font-extrabold shadow
                                     active:scale-[.99] transition"
                              style="background:#0f172a;">
                        + {% trans "–í –∫–æ—Ä–∑–∏–Ω—É" %}
                      </button>
                    </form>
                  </div>
                </div>
              </article>
            {% endif %}
          {% endfor %}
        </div>
      </section>
    {% endfor %}
  </section>

</div>

<!-- toast -->
<div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

<!-- scroll-to-top -->
<a href="#"
   class="to-top"
   id="toTopBtn"
   aria-label="Up">‚¨ÜÔ∏è</a>

<!-- floating cart -->
<a id="cartFab"
   href="{% url 'shops:cart_detail' branch.id %}"
   class="shop-cart-fab {% if cart_qty|default:0 == 0 %}hide{% endif %}">
  <span class="shop-cart-fab__icon">üß∫</span>
  <span class="shop-cart-fab__badge" data-cart-qty>{{ cart_qty }}</span>
  <span class="hidden sm:inline text-white/85" data-cart-total>¬∑ {{ cart_total }} {% trans "—Å–æ–º" %}</span>
</a>

<script>
  function getCookie(name) {
    const v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return v ? decodeURIComponent(v.split('=')[1]) : '';
  }

  function showToast(message){
    const wrap = document.getElementById('toastWrap');
    const el = document.createElement('div');
    el.className = 'toast';
    el.innerHTML = `<span class="dot"></span><div>${message}</div>`;
    wrap.appendChild(el);
    requestAnimationFrame(() => el.classList.add('show'));
    setTimeout(() => {
      el.classList.remove('show');
      setTimeout(() => el.remove(), 220);
    }, 1400);
  }

  function updateCartUI(qty_total, total){
    const qNum = Number(qty_total) || 0;

    document.querySelectorAll('[data-cart-qty]').forEach(el => {
      el.textContent = qNum;
      el.classList.remove('cart-pop');
      void el.offsetWidth;
      el.classList.add('cart-pop');
    });

    document.querySelectorAll('[data-cart-total]').forEach(el => {
      el.textContent = `¬∑ ${total} —Å–æ–º`;
    });

    const fab = document.getElementById('cartFab');
    if (fab){
      fab.classList.toggle('hide', qNum <= 0);
    }
  }

  // AJAX add to cart
  document.addEventListener('submit', async (e) => {
    const form = e.target.closest('form[data-add-to-cart]');
    if (!form) return;

    e.preventDefault();

    const btn = form.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;

    try{
      const resp = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken'),
        }
      });

      const data = await resp.json();
      if (data.ok){
        updateCartUI(data.qty_total, data.total);
        showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É ‚úÖ');
      } else if (data.error === 'not_enough'){
        showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ ‚ùå');
      } else {
        showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å ‚ùå');
      }
    }catch(err){
      console.error(err);
      showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ ‚ùå');
    }finally{
      if (btn) btn.disabled = false;
    }
  }, true);

  // Scroll-to-top show/hide
  (function(){
    const btn = document.getElementById('toTopBtn');
    const onScroll = () => {
      if (window.scrollY > 500) btn.classList.add('show');
      else btn.classList.remove('show');
    };
    window.addEventListener('scroll', onScroll, {passive:true});
    onScroll();
    btn.addEventListener('click', (e)=>{ e.preventDefault(); window.scrollTo({top:0, behavior:'smooth'}); });
  })();

  // Sticky category highlight (IntersectionObserver)
  (function(){
    const links = document.querySelectorAll('[data-cat-link]');
    const map = new Map();
    links.forEach(a => map.set(a.getAttribute('data-cat-link'), a));

    const setActive = (id) => {
      links.forEach(a => a.classList.remove('active'));
      const a = map.get(id);
      if (a) a.classList.add('active');
    };

    // sections to observe
    const sections = document.querySelectorAll('.cat-section');
    if (!sections.length) return;

    const obs = new IntersectionObserver((entries) => {
      // –±–µ—Ä—ë–º —Å–∞–º—ã–π ‚Äú–≤–∏–¥–∏–º—ã–π‚Äù entry
      let best = null;
      for (const e of entries){
        if (e.isIntersecting){
          if (!best || e.intersectionRatio > best.intersectionRatio) best = e;
        }
      }
      if (best){
        setActive(best.target.id);
        // –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –ø–æ–ª–æ—Å–∫—É –∫–∞—Ç–µ–≥–æ—Ä–∏–π, —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤–Ω–∞—è –±—ã–ª–∞ –≤ –≤–∏–¥–∏–º–æ—Å—Ç–∏
        const activeLink = map.get(best.target.id);
        activeLink?.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
      }
    }, { root: null, threshold: [0.2, 0.35, 0.5, 0.65] });

    sections.forEach(s => obs.observe(s));

    // "–í—Å–µ"
    const all = map.get('cat-all');
    all?.addEventListener('click', ()=>setActive('cat-all'));
  })();
</script>
{% endblock %}
