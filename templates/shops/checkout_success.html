{% extends "base.html" %}
{% load i18n %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 py-8">
  <div class="rounded-3xl bg-white ring-1 ring-black/5 shadow-xl p-6">
    <div class="text-2xl font-extrabold">✅ Заказ создан</div>
    <div class="mt-2 text-stone-600">
      Сейчас откроем WhatsApp и отправим заказ в филиал.
    </div>

    <div class="mt-5 rounded-2xl bg-stone-50 ring-1 ring-stone-200 p-4">
      <div class="font-bold text-stone-900">Состав (кратко)</div>
      <div class="mt-2 text-sm text-stone-700">
        {% for it in preview_items %}
          • {{ it.product.name }} × {{ it.qty }}<br>
        {% empty %}
          —
        {% endfor %}
        {% if order.items.all|length > 2 %}…{% endif %}
      </div>
      <div class="mt-3 font-extrabold">Итого: {{ order.total }} сом</div>
    </div>

    <div class="mt-5 flex flex-col sm:flex-row gap-3">
      {% if wa_url %}
        <a href="{{ wa_url }}" class="px-5 py-3 rounded-2xl text-white font-semibold shadow"
           style="background:#25D366;">
          Открыть WhatsApp
        </a>
      {% endif %}

      <button id="copyBtn"
              class="px-5 py-3 rounded-2xl bg-stone-900 text-white font-semibold shadow hover:bg-stone-800">
        Скопировать текст заказа
      </button>
    </div>

    <textarea id="orderText" class="sr-only">{{ order_text }}</textarea>

    <div id="copied" class="mt-3 text-sm text-emerald-700 hidden">Скопировано ✅</div>
    <div class="mt-6 text-xs text-stone-500">
      Если WhatsApp не открылся — нажми “Скопировать” и отправь вручную.
    </div>
  </div>
</div>

<script>
  // автопопытка открыть WhatsApp
  (function(){
    const url = "{{ wa_url|escapejs }}";
    if (!url) return;
    setTimeout(() => { window.location.href = url; }, 400);
  })();

  // копирование
  document.getElementById('copyBtn')?.addEventListener('click', async () => {
    const txt = document.getElementById('orderText')?.value || '';
    try{
      await navigator.clipboard.writeText(txt);
      document.getElementById('copied')?.classList.remove('hidden');
      setTimeout(()=>document.getElementById('copied')?.classList.add('hidden'), 1200);
    }catch(e){
      // fallback
      const ta = document.getElementById('orderText');
      ta.classList.remove('sr-only');
      ta.select();
      document.execCommand('copy');
      ta.classList.add('sr-only');
      document.getElementById('copied')?.classList.remove('hidden');
      setTimeout(()=>document.getElementById('copied')?.classList.add('hidden'), 1200);
    }
  });
</script>
{% endblock %}
